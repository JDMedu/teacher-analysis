<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ìš© ì„±ì  ë¶„ì„ ì‹œìŠ¤í…œ (ê³ 3)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        /* ì—…ë¡œë“œ ì„¹ì…˜ */
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8f2ff;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

/* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .upload-btn.active {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.6);
            transform: scale(1.05);
        }
        
        .upload-btn.inactive {
            opacity: 0.6;
        }
        
        /* ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ */
        .analysis-section {
            display: none;
        }
        
        .subject-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .subject-card h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .student-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #ef4444;
            transition: all 0.3s;
        }
        
        .student-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .student-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }
        
        .student-score {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 4px;
        }
        
        .weak-indicator {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

/* í•™ìƒë³„ ì•½ì  ê·¸ë¦¬ë“œ */
.student-weakness-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.student-weakness-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    border-left: 5px solid #3b82f6;
}

.student-weakness-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.student-weakness-card.priority-high {
    border-left-color: #ef4444;
    background: linear-gradient(135deg, #fff 0%, #fee2e2 100%);
}

.student-weakness-card.priority-medium {
    border-left-color: #f59e0b;
    background: linear-gradient(135deg, #fff 0%, #fef3c7 100%);
}

.student-weakness-card.priority-low {
    border-left-color: #84cc16;
    background: linear-gradient(135deg, #fff 0%, #ecfccb 100%);
}

.student-weakness-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(0,0,0,0.1);
}

.student-weakness-name {
    font-size: 1.3em;
    font-weight: 700;
    color: #1f2937;
}

.student-weakness-number {
    font-size: 0.95em;
    color: #6b7280;
    background: rgba(0,0,0,0.05);
    padding: 4px 10px;
    border-radius: 20px;
}

.student-weakness-subject {
    font-size: 1.1em;
    font-weight: 600;
    color: #3b82f6;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.student-weakness-subject-icon {
    font-size: 1.3em;
}

.student-weakness-stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.student-weakness-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95em;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
}

.student-weakness-label {
    color: #6b7280;
    font-weight: 500;
}

.student-weakness-value {
    font-weight: 700;
    color: #1f2937;
}

.student-weakness-value.low {
    color: #ef4444;
}

.student-weakness-reason {
    margin-top: 12px;
    padding: 10px 12px;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 8px;
    font-size: 0.9em;
    color: #1e40af;
    font-weight: 500;
    text-align: center;
}

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
}

.priority-badge.high {
    background: #fee2e2;
    color: #991b1b;
}

.priority-badge.medium {
    background: #fef3c7;
    color: #92400e;
}

.priority-badge.low {
    background: #ecfccb;
    color: #365314;
}
        
        /* í†µê³„ ëŒ€ì‹œë³´ë“œ */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .student-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
   <div class="container">
    <div class="header">
        <h1>ğŸ“Š êµì‚¬ìš© ì„±ì  ë¶„ì„ ì‹œìŠ¤í…œ</h1>
        <p>í•™ìƒë³„ ê³¼ëª©ë³„ ì•½ì  ë¶„ì„</p>
    </div>
    
    <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="upload-area" id="uploadArea">
        <h3>ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <p>íŒŒì¼ì„ ë“œë˜ê·¸ì•¤ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì„ íƒ</button>
    </div>
    
    <!-- ë¡œë”© í‘œì‹œ -->
    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
        <p>ë¶„ì„ ì¤‘...</p>
    </div>
    
    <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
    <div id="statsDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;"></div>
    
    <!-- íƒ­ ë²„íŠ¼ ì¶”ê°€ -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
        <button id="subjectTab" class="upload-btn" onclick="showTab('subject')" style="background: linear-gradient(45deg, #667eea, #764ba2);">
            ğŸ“š ê³¼ëª©ë³„ ì•½ì 
        </button>
        <button id="studentTab" class="upload-btn" onclick="showTab('student')" style="background: linear-gradient(45deg, #f59e0b, #d97706);">
            ğŸ‘¤ í•™ìƒë³„ ìµœëŒ€ì•½ì 
        </button>
    </div>
    
    <!-- ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ëª©ë¡ -->
    <div id="subjectAnalysis"></div>
    
    <!-- í•™ìƒë³„ ìµœëŒ€ ì•½ì  -->
    <div id="studentWeaknessGrid" style="display: none;"></div>

    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        var studentData = {};
        var weaknessAnalysis = {};
        var studentMaxWeakness = [];  // â¬…ï¸ ì¶”ê°€!
        
        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        var uploadArea = document.getElementById('uploadArea');
        var fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });


       // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
function processFile(file) {
    console.log('íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:', file.name);
    
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            console.log('ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì‹œì‘');
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            
            console.log('ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì™„ë£Œ');
            console.log('ì‹œíŠ¸ ëª©ë¡:', workbook.SheetNames);
            
            // â­ 1ë‹¨ê³„: í•™ìƒ ë°ì´í„° íŒŒì‹± â­
            parseStudentData(workbook);
            
            // â­ 2ë‹¨ê³„: ì•½ì  ë¶„ì„ â­
            analyzeWeaknesses();
            
            // â­ 3ë‹¨ê³„: ê²°ê³¼ í‘œì‹œ â­
            displayResults();
            
        } catch (error) {
            console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ===== ì‹œí—˜ë³„ ê³¼ëª©ë³„ í†µê³„ ê³„ì‚° í•¨ìˆ˜ =====
function calculateTestStatistics(workbook, recentTests) {
    var testStats = {};
    
    recentTests.forEach(function(testName) {
        var sheet = workbook.Sheets[testName];
        if (!sheet) return;
        
        var data = XLSX.utils.sheet_to_json(sheet, {header: 1});
        if (data.length < 2) return;
        
        var headers = data[0];
        testStats[testName] = {};
        
        console.log('\nğŸ“Š ' + testName + ' í†µê³„ ê³„ì‚° ì¤‘...');
        
        // ê³¼ëª©ë³„ í†µê³„ ê³„ì‚° (ì„ íƒê³¼ëª©ë³„ë¡œ)
        var ì–¸ì–´ì™€ë§¤ì²´Scores = {};
        var í™”ë²•ê³¼ì‘ë¬¸Scores = {};
        
        // ì ìˆ˜ ìˆ˜ì§‘
        for (var i = 1; i < data.length; i++) {
            var row = data[i];
            if (!row || !row[2]) continue;
            
            var subjectType = String(row[2]).trim();
            var track = getTrack(subjectType);
            
            for (var col = 5; col < headers.length; col++) {
                var subjectName = normalizeHeader(headers[col]);
                var score = parseFloat(row[col]) || 0;
                
                if (score > 0) {
                    if (track === 'ì–¸ì–´ì™€ë§¤ì²´') {
                        if (!ì–¸ì–´ì™€ë§¤ì²´Scores[subjectName]) ì–¸ì–´ì™€ë§¤ì²´Scores[subjectName] = [];
                        ì–¸ì–´ì™€ë§¤ì²´Scores[subjectName].push(score);
                    } else {
                        if (!í™”ë²•ê³¼ì‘ë¬¸Scores[subjectName]) í™”ë²•ê³¼ì‘ë¬¸Scores[subjectName] = [];
                        í™”ë²•ê³¼ì‘ë¬¸Scores[subjectName].push(score);
                    }
                }
            }
        }
        
        // í†µê³„ ê³„ì‚°
        testStats[testName] = {
            'ì–¸ì–´ì™€ë§¤ì²´': {},
            'í™”ë²•ê³¼ì‘ë¬¸': {}
        };
        
        // ì–¸ì–´ì™€ë§¤ì²´ í†µê³„
        for (var subject in ì–¸ì–´ì™€ë§¤ì²´Scores) {
            var scores = ì–¸ì–´ì™€ë§¤ì²´Scores[subject];
            if (scores.length === 0) continue;
            
            var mean = scores.reduce((a, b) => a + b) / scores.length;
            var variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
            var stdDev = Math.sqrt(variance);
            
            testStats[testName]['ì–¸ì–´ì™€ë§¤ì²´'][subject] = {
                mean: mean,
                stdDev: stdDev,
                count: scores.length
            };
        }
        
        // í™”ë²•ê³¼ì‘ë¬¸ í†µê³„
        for (var subject in í™”ë²•ê³¼ì‘ë¬¸Scores) {
            var scores = í™”ë²•ê³¼ì‘ë¬¸Scores[subject];
            if (scores.length === 0) continue;
            
            var mean = scores.reduce((a, b) => a + b) / scores.length;
            var variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
            var stdDev = Math.sqrt(variance);
            
            testStats[testName]['í™”ë²•ê³¼ì‘ë¬¸'][subject] = {
                mean: mean,
                stdDev: stdDev,
                count: scores.length
            };
            
            console.log('  ' + subject + ' (í™”ì‘): í‰ê· =' + Math.round(mean) + ', í‘œì¤€í¸ì°¨=' + Math.round(stdDev));
        }
    });
    
    return testStats;
}

// ===== í•™ìƒ ë°ì´í„° íŒŒì‹± í•¨ìˆ˜ (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹) =====
function parseStudentData(workbook) {
    console.log('=== í•™ìƒ ë°ì´í„° íŒŒì‹± ì‹œì‘ (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹) ===');
    
    studentData = {};
    
    // 2ë²ˆì§¸ ì‹œíŠ¸: ì¶œê²°ë²ˆí˜¸-ì´ë¦„ ë§¤í•‘
    var mappingSheetName = workbook.SheetNames[1];
    var mappingSheet = workbook.Sheets[mappingSheetName];
    var mappingData = XLSX.utils.sheet_to_json(mappingSheet, {header: 1});
    
    var attendanceToNameMap = {};
    
    for (var i = 1; i < mappingData.length; i++) {
        var row = mappingData[i];
        if (row && row[0] && row[1]) {
            var name = row[0];
            var attendanceNumber = String(row[1]);
            attendanceToNameMap[attendanceNumber] = name;
            
            studentData[attendanceNumber] = {
                name: name,
                attendanceNumber: attendanceNumber,
                testScores: {},      // ì›ì ìˆ˜ ì €ì¥
                testRatios: {},      // ì„±ì·¨ë„(%) ì €ì¥
                subjectAverages: {}, // ì„±ì·¨ë„ í‰ê· 
                subjectZScores: {}   // Z-Score í‰ê· 
            };
        }
    }
    
    console.log('ë§¤í•‘ëœ í•™ìƒ ìˆ˜:', Object.keys(attendanceToNameMap).length);
    
    // ì‹œí—˜ ì‹œíŠ¸ ì°¾ê¸°
    var allSheets = workbook.SheetNames;
    var testSheets = [];
    
    for (var i = 0; i < allSheets.length; i++) {
        var sheetName = allSheets[i];
        if ((sheetName.includes('ëª¨í´') || sheetName.includes('ì´ê°') || sheetName.includes('ì§„ë‹¨í‰ê°€')) &&
            !sheetName.includes('ì„±ì í‘œ') && sheetName !== 'ë“±ê¸‰ì»·' && sheetName !== 'ì¶œê²°ë²ˆí˜¸') {
            testSheets.push(sheetName);
        }
    }
    
    console.log('ë°œê²¬ëœ ì‹œí—˜ ì‹œíŠ¸:', testSheets);
    
    // ìµœê·¼ 10íšŒë§Œ ì„ íƒ
    var recentTests = testSheets.slice(-10);
    console.log('ìµœê·¼ 10íšŒ ì‹œí—˜:', recentTests);
    
    // â­ í†µê³„ ê³„ì‚° â­
    var testStats = calculateTestStatistics(workbook, recentTests);
    window.testStats = testStats;
    
    // â­ ê° ì‹œí—˜ ì²˜ë¦¬ â­
    recentTests.forEach(function(testName) {
        console.log('\nì²˜ë¦¬ ì¤‘:', testName);
        
        var sheet = workbook.Sheets[testName];
        var data = XLSX.utils.sheet_to_json(sheet, {header: 1});
        
        if (data.length < 2) return;
        
        var headers = data[0];
        
        // ë§Œì  í•™ìƒ ì°¾ê¸°
        var ì–¸ì–´ì™€ë§¤ì²´ìµœê³ Row = null;
        var í™”ë²•ê³¼ì‘ë¬¸ìµœê³ Row = null;
        var ì–¸ì–´ì™€ë§¤ì²´ìµœê³ ì  = 0;
        var í™”ë²•ê³¼ì‘ë¬¸ìµœê³ ì  = 0;
        
        for (var i = 1; i < data.length; i++) {
            var row = data[i];
            if (!row || !row[1] || !row[2] || !row[4]) continue;
            
            var subjectType = String(row[2]).trim();
            var totalScore = parseFloat(row[4]) || 0;
            
            if (subjectType.includes('ì–¸ì–´') || subjectType.includes('ë§¤ì²´')) {
                if (totalScore > ì–¸ì–´ì™€ë§¤ì²´ìµœê³ ì ) {
                    ì–¸ì–´ì™€ë§¤ì²´ìµœê³ Row = row;
                    ì–¸ì–´ì™€ë§¤ì²´ìµœê³ ì  = totalScore;
                }
            }
            
            if (subjectType.includes('í™”ë²•') || subjectType.includes('ì‘ë¬¸')) {
                if (totalScore > í™”ë²•ê³¼ì‘ë¬¸ìµœê³ ì ) {
                    í™”ë²•ê³¼ì‘ë¬¸ìµœê³ Row = row;
                    í™”ë²•ê³¼ì‘ë¬¸ìµœê³ ì  = totalScore;
                }
            }
        }
        
        if (!ì–¸ì–´ì™€ë§¤ì²´ìµœê³ Row || !í™”ë²•ê³¼ì‘ë¬¸ìµœê³ Row) {
            console.warn('âš ï¸ ë§Œì  í•™ìƒ ë¶€ì¡±:', testName);
            return;
        }
        
        // ë§Œì  ë°ì´í„° ì €ì¥
        var maxScores = {
            'ì–¸ì–´ì™€ë§¤ì²´': {},
            'í™”ë²•ê³¼ì‘ë¬¸': {}
        };
        
        for (var col = 5; col < headers.length; col++) {
            var subjectName = normalizeHeader(headers[col]);
            maxScores['ì–¸ì–´ì™€ë§¤ì²´'][subjectName] = parseFloat(ì–¸ì–´ì™€ë§¤ì²´ìµœê³ Row[col]) || 0;
            maxScores['í™”ë²•ê³¼ì‘ë¬¸'][subjectName] = parseFloat(í™”ë²•ê³¼ì‘ë¬¸ìµœê³ Row[col]) || 0;
        }
        
        // â­ ê° í•™ìƒì˜ ì›ì ìˆ˜ ë° ì„±ì·¨ë„, Z-Score ê³„ì‚° â­
        for (var i = 1; i < data.length; i++) {
            var row = data[i];
            if (!row || !row[0] || !row[1]) continue;
            
            var name = row[0];
            var attendanceNumber = String(row[1]);
            var subjectType = row[2] || 'í™”ë²•ê³¼ ì‘ë¬¸';
            
            if (!studentData[attendanceNumber]) continue;
            
            var track = getTrack(subjectType);
            var maxScoreData = maxScores[track];
            var statsData = testStats[testName][track];
            
            var subjectScores = {};   // ì›ì ìˆ˜
            var subjectRatios = {};   // ì„±ì·¨ë„(%)
            var subjectZScores = {};  // Z-Score
            
            for (var col = 5; col < headers.length; col++) {
                var subjectName = normalizeHeader(headers[col]);
                var studentScore = parseFloat(row[col]) || 0;
                var maxScore = maxScoreData[subjectName] || 0;
                
                if (maxScore > 0 && studentScore >= 0) {
                    // ì›ì ìˆ˜ ì €ì¥
                    subjectScores[subjectName] = studentScore;
                    
                    // ì„±ì·¨ë„(%) ê³„ì‚°
                    var ratio = Math.round((studentScore / maxScore) * 100);
                    subjectRatios[subjectName] = ratio;
                    
                    // Z-Score ê³„ì‚°
                    if (statsData && statsData[subjectName]) {
                        var stats = statsData[subjectName];
                        var zScore = stats.stdDev > 0 ? (studentScore - stats.mean) / stats.stdDev : 0;
                        subjectZScores[subjectName] = zScore;
                    }
                }
            }
            
            studentData[attendanceNumber].testScores[testName] = subjectScores;
            studentData[attendanceNumber].testRatios[testName] = subjectRatios;
            
            // Z-Score ì €ì¥
            for (var subject in subjectZScores) {
                if (!studentData[attendanceNumber].subjectZScores[subject]) {
                    studentData[attendanceNumber].subjectZScores[subject] = [];
                }
                studentData[attendanceNumber].subjectZScores[subject].push(subjectZScores[subject]);
            }
        }
    });
    
    // â­ ê° í•™ìƒì˜ ê³¼ëª©ë³„ í‰ê·  ê³„ì‚° â­
    for (var attendanceNumber in studentData) {
        var student = studentData[attendanceNumber];
        var subjectRatioTotals = {};
        var subjectRatioCounts = {};
        
        // ì„±ì·¨ë„ í‰ê·  ê³„ì‚°
        for (var testName in student.testRatios) {
            var testRatios = student.testRatios[testName];
            
            for (var subject in testRatios) {
                if (!subjectRatioTotals[subject]) {
                    subjectRatioTotals[subject] = 0;
                    subjectRatioCounts[subject] = 0;
                }
                
                subjectRatioTotals[subject] += testRatios[subject];
                subjectRatioCounts[subject]++;
            }
        }
        
        for (var subject in subjectRatioTotals) {
            student.subjectAverages[subject] = Math.round((subjectRatioTotals[subject] / subjectRatioCounts[subject]) * 10) / 10;
        }
    }
    
    console.log('íŒŒì‹± ì™„ë£Œ. í•™ìƒ ìˆ˜:', Object.keys(studentData).length);
}

// ì„ íƒê³¼ëª© êµ¬ë¶„ í•¨ìˆ˜
function getTrack(subjectTypeCell) {
    var v = (subjectTypeCell || '').toString().replace(/\s/g, '');
    if (v.includes('ì–¸ì–´') || v.includes('ë§¤ì²´')) return 'ì–¸ì–´ì™€ë§¤ì²´';
    return 'í™”ë²•ê³¼ì‘ë¬¸';
}

// í—¤ë” ì •ê·œí™” í•¨ìˆ˜
function normalizeHeader(h) {
    return String(h == null ? '' : h).replace(/\s/g, '').trim();
}


      // ===== ì•½ì  ë¶„ì„ í•¨ìˆ˜ (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹) =====
function analyzeWeaknesses() {
    weaknessAnalysis = {};
    
    console.log('=== ì•½ì  ë¶„ì„ ì‹œì‘ (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹) ===');
    
    // ê³¼ëª© ëª©ë¡ ì •ì˜
    var subjects = [
        'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )',
        'ë…ì„œ(ì‚¬íšŒ)',
        'ë…ì„œ(ê³¼í•™)',
        'ë¬¸í•™(í˜„ëŒ€ì‹œ)',
        'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)',
        'ë¬¸í•™(ê³ ì „ì‹œê°€)',
        'ë¬¸í•™(ê³ ì „ì†Œì„¤)',
        'ì–¸ì–´ í™”ë²•',
        'ë§¤ì²´ ì‘ë¬¸'
    ];
    
    // ê° ê³¼ëª©ë³„ë¡œ ì´ˆê¸°í™”
    subjects.forEach(function(subject) {
        weaknessAnalysis[subject] = [];
    });
    
    // ê° í•™ìƒ ë¶„ì„
    for (var attendanceNumber in studentData) {
        var student = studentData[attendanceNumber];
        
        // ê³¼ëª©ë³„ í‰ê· ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if (Object.keys(student.subjectAverages).length === 0) continue;
        
        // í•™ìƒì˜ ì „ì²´ í‰ê·  ì„±ì·¨ë„ ê³„ì‚°
        var totalSum = 0;
        var totalCount = 0;
        
        for (var subject in student.subjectAverages) {
            totalSum += student.subjectAverages[subject];
            totalCount++;
        }
        
        var studentAverage = totalSum / totalCount;
        
        // í•™ìƒì˜ ì „ì²´ í‰ê·  Z-Score ê³„ì‚°
        var totalZScores = [];
        for (var subject in student.subjectZScores) {
            var zScores = student.subjectZScores[subject];
            var avgZ = zScores.reduce((a, b) => a + b) / zScores.length;
            totalZScores.push(avgZ);
        }
        var studentAvgZ = totalZScores.length > 0 ? totalZScores.reduce((a, b) => a + b) / totalZScores.length : 0;
        
        // ê° ê³¼ëª© ë¶„ì„
        for (var actualSubject in student.subjectAverages) {
            var subjectAverage = student.subjectAverages[actualSubject];  // ì„±ì·¨ë„(%)
            var difference = studentAverage - subjectAverage;
            
            // Z-Score ê³„ì‚°
            var avgZScore = 0;
            var zDifference = 0;
            
            if (student.subjectZScores[actualSubject]) {
                var zScores = student.subjectZScores[actualSubject];
                avgZScore = zScores.reduce((a, b) => a + b) / zScores.length;
                zDifference = studentAvgZ - avgZScore;
            }
            
            // â­ í•˜ì´ë¸Œë¦¬ë“œ ì•½ì  íŒì • â­
            var isWeak = false;
            var priority = 'low';
            var reason = '';
            
            // 1ìˆœìœ„: ì ˆëŒ€ì ìœ¼ë¡œ ë‚®ìŒ (ì„±ì·¨ë„ 70% ë¯¸ë§Œ)
            if (subjectAverage < 70) {
                isWeak = true;
                priority = 'high';
                reason = 'ì ˆëŒ€ì  ì•½ì  (70% ë¯¸ë§Œ)';
            }
            // 2ìˆœìœ„: Z-Scoreë¡œ ì‹¬ê°í•˜ê²Œ ë‚®ìŒ (í‰ê· ë³´ë‹¤ 1 í‘œì¤€í¸ì°¨ ì´ìƒ ë‚®ìŒ)
            else if (avgZScore < -1.0) {
                isWeak = true;
                priority = 'high';
                reason = 'ì „ì²´ ëŒ€ë¹„ ì‹¬ê° (í‰ê·  -1Ïƒ ì´í•˜)';
            }
            // 3ìˆœìœ„: ë³¸ì¸ ëŒ€ë¹„ ìƒëŒ€ì ìœ¼ë¡œ ë‚®ìŒ (ë³¸ì¸ í‰ê· ë³´ë‹¤ 10% ì´ìƒ)
            else if (difference >= 10) {
                isWeak = true;
                priority = 'medium';
                reason = 'ë³¸ì¸ ëŒ€ë¹„ ì•½ì  (í‰ê·  -10%)';
            }
            // 4ìˆœìœ„: ë³¸ì¸ ë‚´ì—ì„œ Z-Scoreê°€ ë‚®ìŒ
            else if (zDifference > 0.5) {
                isWeak = true;
                priority = 'medium';
                reason = 'ë³¸ì¸ ë‚´ ìƒëŒ€ì  ì•½ì ';
            }
            
            if (isWeak) {
                var matchedSubject = findMatchingSubjectAdvanced(actualSubject, subjects);
                
                if (matchedSubject && weaknessAnalysis[matchedSubject]) {
                    weaknessAnalysis[matchedSubject].push({
                        name: student.name,
                        attendanceNumber: attendanceNumber,
                        subjectAverage: Math.round(subjectAverage * 10) / 10,
                        studentAverage: Math.round(studentAverage * 10) / 10,
                        difference: Math.round(difference * 10) / 10,
                        avgZScore: Math.round(avgZScore * 100) / 100,
                        priority: priority,
                        reason: reason
                    });
                }
            }
        }
    }
    
    // ê° ê³¼ëª©ë³„ë¡œ ìš°ì„ ìˆœìœ„ â†’ ì°¨ì´ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬
    for (var subject in weaknessAnalysis) {
        weaknessAnalysis[subject].sort(function(a, b) {
            // ìš°ì„ ìˆœìœ„ ì •ë ¬
            if (a.priority !== b.priority) {
                var priorityOrder = {'high': 0, 'medium': 1, 'low': 2};
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            }
            // ê°™ì€ ìš°ì„ ìˆœìœ„ë©´ ì°¨ì´ í° ìˆœ
            return b.difference - a.difference;
        });
    }
    
    console.log('=== ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ìˆ˜ ===');
    for (var subject in weaknessAnalysis) {
        if (weaknessAnalysis[subject].length > 0) {
            var highCount = weaknessAnalysis[subject].filter(s => s.priority === 'high').length;
            var mediumCount = weaknessAnalysis[subject].filter(s => s.priority === 'medium').length;
            console.log(subject + ':', weaknessAnalysis[subject].length + 'ëª… (ğŸ”´' + highCount + ' ğŸŸ¡' + mediumCount + ')');
        }
    }
    
    console.log('ì•½ì  ë¶„ì„ ì™„ë£Œ (í•˜ì´ë¸Œë¦¬ë“œ):', weaknessAnalysis);
}

// ê³¼ëª©ëª… ë§¤ì¹­ í•¨ìˆ˜
function findMatchingSubjectAdvanced(actualSubject, standardSubjects) {
    var subjectMapping = {
        'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )': ['ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )', 'ë…ì„œ(ì¸ë¬¸ ì´ë¡ )', 'ë…ì„œ(ì¸ë¬¸ì´ë¡ )', 'ë…ì„œì¸ë¬¸', 'ì¸ë¬¸'],
        'ë…ì„œ(ì‚¬íšŒ)': ['ë…ì„œ(ì‚¬íšŒ)', 'ë…ì„œì‚¬íšŒ', 'ì‚¬íšŒ'],
        'ë…ì„œ(ê³¼í•™)': ['ë…ì„œ(ê³¼í•™)', 'ë…ì„œê³¼í•™', 'ê³¼í•™'],
        'ë¬¸í•™(í˜„ëŒ€ì‹œ)': ['ë¬¸í•™(í˜„ëŒ€ì‹œ)', 'ë¬¸í•™í˜„ëŒ€ì‹œ', 'í˜„ëŒ€ì‹œ', 'í˜„ì‹œ'],
        'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)': ['ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)', 'ë¬¸í•™í˜„ëŒ€ì†Œì„¤', 'í˜„ëŒ€ì†Œì„¤', 'í˜„ì†Œ'],
        'ë¬¸í•™(ê³ ì „ì‹œê°€)': ['ë¬¸í•™(ê³ ì „ì‹œê°€)', 'ë¬¸í•™ê³ ì „ì‹œê°€', 'ê³ ì „ì‹œê°€', 'ê³ ì‹œ'],
        'ë¬¸í•™(ê³ ì „ì†Œì„¤)': ['ë¬¸í•™(ê³ ì „ì†Œì„¤)', 'ë¬¸í•™ê³ ì „ì†Œì„¤', 'ê³ ì „ì†Œì„¤', 'ê³ ì†Œ'],
        'ì–¸ì–´ í™”ë²•': ['ì–¸ì–´ í™”ë²•', 'ì–¸ì–´í™”ë²•', 'í™”ë²•', 'ì–¸ì–´'],
        'ë§¤ì²´ ì‘ë¬¸': ['ë§¤ì²´ ì‘ë¬¸', 'ë§¤ì²´ì‘ë¬¸', 'ì‘ë¬¸', 'ë§¤ì²´']
    };
    
    // 1. ì •í™• ì¼ì¹˜
    for (var standardSubject in subjectMapping) {
        var possibleNames = subjectMapping[standardSubject];
        
        for (var i = 0; i < possibleNames.length; i++) {
            if (actualSubject === possibleNames[i]) {
                return standardSubject;
            }
        }
    }
    
    // 2. ë¶€ë¶„ ì¼ì¹˜
    for (var standardSubject in subjectMapping) {
        var possibleNames = subjectMapping[standardSubject];
        
        for (var i = 0; i < possibleNames.length; i++) {
            if (actualSubject.includes(possibleNames[i]) || possibleNames[i].includes(actualSubject)) {
                return standardSubject;
            }
        }
    }
    
    return null;
}

    // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function displayResults() {
    console.log('=== ê²°ê³¼ í‘œì‹œ ì‹œì‘ ===');
    
    // 1. í†µê³„ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
    displayStatsDashboard();
    
    // 2. ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ëª©ë¡ í‘œì‹œ (ê¸°ë³¸ íƒ­)
    displaySubjectAnalysis();
    
    // 3. ê¸°ë³¸ìœ¼ë¡œ ê³¼ëª©ë³„ íƒ­ í™œì„±í™”
    showTab('subject');
}
    
// ===== í•™ìƒë³„ ìµœëŒ€ ì•½ì  ë¶„ì„ =====
function analyzeStudentMaxWeakness() {
    var studentMaxWeakness = [];
    
    console.log('=== í•™ìƒë³„ ìµœëŒ€ ì•½ì  ë¶„ì„ ì‹œì‘ ===');
    
    // ê° í•™ìƒë³„ë¡œ ê°€ì¥ ì•½í•œ ê³¼ëª© ì°¾ê¸°
    for (var attendanceNumber in studentData) {
        var student = studentData[attendanceNumber];
        
        if (Object.keys(student.subjectAverages).length === 0) continue;
        
        // í•™ìƒì˜ ì „ì²´ í‰ê· 
        var totalSum = 0;
        var totalCount = 0;
        
        for (var subject in student.subjectAverages) {
            totalSum += student.subjectAverages[subject];
            totalCount++;
        }
        
        var studentAverage = totalSum / totalCount;
        
        // í•™ìƒì˜ ì „ì²´ í‰ê·  Z-Score
        var totalZScores = [];
        for (var subject in student.subjectZScores) {
            var zScores = student.subjectZScores[subject];
            var avgZ = zScores.reduce((a, b) => a + b) / zScores.length;
            totalZScores.push(avgZ);
        }
        var studentAvgZ = totalZScores.length > 0 ? totalZScores.reduce((a, b) => a + b) / totalZScores.length : 0;
        
        // ëª¨ë“  ê³¼ëª©ì˜ ì•½ì  ì ìˆ˜ ê³„ì‚°
        var weaknessScores = [];
        
        for (var actualSubject in student.subjectAverages) {
            var subjectAverage = student.subjectAverages[actualSubject];
            var difference = studentAverage - subjectAverage;
            
            // Z-Score ê³„ì‚°
            var avgZScore = 0;
            var zDifference = 0;
            
            if (student.subjectZScores[actualSubject]) {
                var zScores = student.subjectZScores[actualSubject];
                avgZScore = zScores.reduce((a, b) => a + b) / zScores.length;
                zDifference = studentAvgZ - avgZScore;
            }
            
            // ì•½ì  íŒì •
            var priority = 'low';
            var reason = '';
            var weaknessScore = 0;  // ì•½ì  ì •ë„ (ë†’ì„ìˆ˜ë¡ ì‹¬ê°)
            
            if (subjectAverage < 70) {
                priority = 'high';
                reason = 'ì ˆëŒ€ì  ì•½ì  (70% ë¯¸ë§Œ)';
                weaknessScore = 100 - subjectAverage + difference;
            } else if (avgZScore < -1.0) {
                priority = 'high';
                reason = 'ì „ì²´ ëŒ€ë¹„ ì‹¬ê° (í‰ê·  -1Ïƒ ì´í•˜)';
                weaknessScore = 50 + Math.abs(avgZScore) * 10 + difference;
            } else if (difference >= 10) {
                priority = 'medium';
                reason = 'ë³¸ì¸ ëŒ€ë¹„ ì•½ì  (í‰ê·  -10%)';
                weaknessScore = difference;
            } else if (zDifference > 0.5) {
                priority = 'medium';
                reason = 'ë³¸ì¸ ë‚´ ìƒëŒ€ì  ì•½ì ';
                weaknessScore = zDifference * 10;
            }
            
            weaknessScores.push({
                subject: actualSubject,
                subjectAverage: subjectAverage,
                difference: difference,
                avgZScore: avgZScore,
                priority: priority,
                reason: reason,
                weaknessScore: weaknessScore
            });
        }
        
        // ê°€ì¥ ì•½í•œ ê³¼ëª© ì°¾ê¸° (weaknessScoreê°€ ê°€ì¥ ë†’ì€ ê²ƒ)
        if (weaknessScores.length > 0) {
            weaknessScores.sort((a, b) => b.weaknessScore - a.weaknessScore);
            var maxWeakness = weaknessScores[0];
            
            // ì•½ì ì´ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€ (ìµœì†Œ ì¡°ê±´: ë³¸ì¸ í‰ê· ë³´ë‹¤ 5% ì´ìƒ ë‚®ê±°ë‚˜ Z-Score < -0.5)
            if (maxWeakness.difference >= 5 || maxWeakness.avgZScore < -0.5) {
                studentMaxWeakness.push({
                    name: student.name,
                    attendanceNumber: attendanceNumber,
                    subject: maxWeakness.subject,
                    subjectAverage: Math.round(maxWeakness.subjectAverage * 10) / 10,
                    studentAverage: Math.round(studentAverage * 10) / 10,
                    difference: Math.round(maxWeakness.difference * 10) / 10,
                    avgZScore: Math.round(maxWeakness.avgZScore * 100) / 100,
                    priority: maxWeakness.priority,
                    reason: maxWeakness.reason
                });
            }
        }
    }
    
    // ìš°ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬
    studentMaxWeakness.sort(function(a, b) {
        var priorityOrder = {'high': 0, 'medium': 1, 'low': 2};
        
        if (a.priority !== b.priority) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        
        return b.difference - a.difference;
    });
    
    console.log('=== í•™ìƒë³„ ìµœëŒ€ ì•½ì  ë¶„ì„ ì™„ë£Œ ===');
    console.log('ì´ í•™ìƒ ìˆ˜:', studentMaxWeakness.length);
    
    return studentMaxWeakness;
}

// ===== í•™ìƒë³„ ì•½ì  í‘œì‹œ =====
function displayStudentWeakness() {
    console.log('=== í•™ìƒë³„ ì•½ì  í‘œì‹œ ì‹œì‘ ===');
    
    studentMaxWeakness = analyzeStudentMaxWeakness();  // â¬…ï¸ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
    var container = document.getElementById('studentWeaknessGrid');
    
    if (!container) {
        console.error('âŒ studentWeaknessGrid ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    if (studentMaxWeakness.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280; grid-column: 1 / -1;">ì•½ì ì´ ë°œê²¬ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    var html = '';
    
    // â­ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€ â­
    html += '<div style="text-align: center; margin-bottom: 30px; grid-column: 1 / -1;">';
    html += '<button class="upload-btn" onclick="downloadStudentExcel()" style="background: linear-gradient(45deg, #10b981, #059669);">';
    html += 'ğŸ“¥ í•™ìƒë³„ ì•½ì  ì—‘ì…€ ë‹¤ìš´ë¡œë“œ';
    html += '</button>';
    html += '</div>';
    
    // ê³¼ëª©ë³„ ì•„ì´ì½˜ ë§¤í•‘
    var subjectIcons = {
        'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )': 'ğŸ“–',
        'ë…ì„œ(ì‚¬íšŒ)': 'ğŸ›ï¸',
        'ë…ì„œ(ê³¼í•™)': 'ğŸ”¬',
        'ë¬¸í•™(í˜„ëŒ€ì‹œ)': 'âœï¸',
        'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)': 'ğŸ“š',
        'ë¬¸í•™(ê³ ì „ì‹œê°€)': 'ğŸ­',
        'ë¬¸í•™(ê³ ì „ì†Œì„¤)': 'ğŸ“œ',
        'ì–¸ì–´ í™”ë²•': 'ğŸ’¬',
        'ë§¤ì²´ ì‘ë¬¸': 'ğŸ“±'
    };
    
    studentMaxWeakness.forEach(function(student) {
        // í‘œì¤€ ê³¼ëª©ëª… ì°¾ê¸°
        var subjects = Object.keys(subjectIcons);
        var matchedSubject = findMatchingSubjectAdvanced(student.subject, subjects);
        var displaySubject = matchedSubject || student.subject;
        var icon = subjectIcons[displaySubject] || 'ğŸ“';
        
        var priorityIcon = student.priority === 'high' ? 'ğŸ”´' : 
                          student.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
        
        html += '<div class="student-weakness-card priority-' + student.priority + '" onclick="showStudentDetail(\'' + student.attendanceNumber + '\')">';
        
        // í—¤ë”
        html += '<div class="student-weakness-header">';
        html += '<div class="student-weakness-name">' + priorityIcon + ' ' + student.name + '</div>';
        html += '<div class="student-weakness-number">' + student.attendanceNumber + '</div>';
        html += '</div>';
        
        // ì•½ì  ê³¼ëª©
        html += '<div class="student-weakness-subject">';
        html += '<span class="student-weakness-subject-icon">' + icon + '</span>';
        html += '<span>' + displaySubject + '</span>';
        html += '</div>';
        
        // í†µê³„
        html += '<div class="student-weakness-stats">';
        
        html += '<div class="student-weakness-stat">';
        html += '<span class="student-weakness-label">ê³¼ëª© ì„±ì·¨ë„</span>';
        html += '<span class="student-weakness-value low">' + student.subjectAverage + '%</span>';
        html += '</div>';
        
        html += '<div class="student-weakness-stat">';
        html += '<span class="student-weakness-label">ë³¸ì¸ í‰ê· </span>';
        html += '<span class="student-weakness-value">' + student.studentAverage + '%</span>';
        html += '</div>';
        
        html += '<div class="student-weakness-stat">';
        html += '<span class="student-weakness-label">ì°¨ì´</span>';
        html += '<span class="student-weakness-value low">-' + student.difference + '%</span>';
        html += '</div>';
        
        html += '</div>';
        
        // ì´ìœ 
        html += '<div class="student-weakness-reason">';
        html += 'ğŸ“Š ' + student.reason;
        html += '</div>';
        
        html += '</div>';
    });
    
    container.innerHTML = html;
    console.log('âœ… í•™ìƒë³„ ì•½ì  í‘œì‹œ ì™„ë£Œ:', studentMaxWeakness.length + 'ëª…');
}

// ===== í•™ìƒ ìƒì„¸ë³´ê¸° (ë‚˜ì¤‘ì— í™•ì¥ ê°€ëŠ¥) =====
function showStudentDetail(attendanceNumber) {
    var student = studentData[attendanceNumber];
    
    if (!student) return;
    
    alert('ğŸ¯ ' + student.name + ' (' + attendanceNumber + ') í•™ìƒì˜ ìƒì„¸ ë¶„ì„\n\n' +
          'ë³¸ì¸ í‰ê· : ' + Math.round(Object.values(student.subjectAverages).reduce((a, b) => a + b) / Object.keys(student.subjectAverages).length * 10) / 10 + '%\n\n' +
          'ê³¼ëª©ë³„ ì„±ì·¨ë„:\n' + 
          Object.keys(student.subjectAverages).map(function(subject) {
              return '  â€¢ ' + subject + ': ' + student.subjectAverages[subject] + '%';
          }).join('\n'));
}

// ===== íƒ­ ì „í™˜ í•¨ìˆ˜ =====
function showTab(tabName) {
    console.log('íƒ­ ì „í™˜:', tabName);
    
    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    var subjectTab = document.getElementById('subjectTab');
    var studentTab = document.getElementById('studentTab');
    
    if (subjectTab && studentTab) {
        if (tabName === 'subject') {
            subjectTab.classList.add('active');
            subjectTab.classList.remove('inactive');
            studentTab.classList.remove('active');
            studentTab.classList.add('inactive');
        } else {
            studentTab.classList.add('active');
            studentTab.classList.remove('inactive');
            subjectTab.classList.remove('active');
            subjectTab.classList.add('inactive');
        }
    }
    
    // ì»¨í…ì¸  ì „í™˜
    var subjectAnalysis = document.getElementById('subjectAnalysis');
    var studentWeaknessGrid = document.getElementById('studentWeaknessGrid');
    
    if (tabName === 'subject') {
        if (subjectAnalysis) subjectAnalysis.style.display = 'block';
        if (studentWeaknessGrid) studentWeaknessGrid.style.display = 'none';
    } else if (tabName === 'student') {
        if (subjectAnalysis) subjectAnalysis.style.display = 'none';
        if (studentWeaknessGrid) {
            studentWeaknessGrid.style.display = 'grid';
            studentWeaknessGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(320px, 1fr))';
            studentWeaknessGrid.style.gap = '20px';
        }
        
        // í•™ìƒë³„ ì•½ì  í‘œì‹œ
        displayStudentWeakness();
    }
}
    


// í†µê³„ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
function displayStatsDashboard() {
    var statsDashboard = document.getElementById('statsDashboard');
    
    if (!statsDashboard) {
        console.error('âŒ statsDashboard ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    // ì „ì²´ í•™ìƒ ìˆ˜
    var totalStudents = Object.keys(studentData).length;
    
    // ë¶„ì„ëœ ê³¼ëª© ìˆ˜
    var analyzedSubjects = Object.keys(weaknessAnalysis).filter(function(subject) {
        return weaknessAnalysis[subject].length > 0;
    }).length;
    
    // ì•½ì ì´ ìˆëŠ” í•™ìƒ ìˆ˜ (ì¤‘ë³µ ì œê±°)
    var weakStudentsSet = new Set();
    for (var subject in weaknessAnalysis) {
        weaknessAnalysis[subject].forEach(function(student) {
            weakStudentsSet.add(student.attendanceNumber);
        });
    }
    var weakStudentsCount = weakStudentsSet.size;
    
    // ê°€ì¥ ë§ì€ í•™ìƒì´ ì•½í•œ ê³¼ëª©
    var maxWeakSubject = '';
    var maxWeakCount = 0;
    for (var subject in weaknessAnalysis) {
        if (weaknessAnalysis[subject].length > maxWeakCount) {
            maxWeakCount = weaknessAnalysis[subject].length;
            maxWeakSubject = subject;
        }
    }
    
    var html = '';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value">' + totalStudents + '</div>';
    html += '<div class="stat-label">ì „ì²´ í•™ìƒ ìˆ˜</div>';
    html += '</div>';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value">' + analyzedSubjects + '</div>';
    html += '<div class="stat-label">ë¶„ì„ëœ ê³¼ëª© ìˆ˜</div>';
    html += '</div>';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value">' + weakStudentsCount + '</div>';
    html += '<div class="stat-label">ì•½ì ì´ ìˆëŠ” í•™ìƒ</div>';
    html += '</div>';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value" style="font-size: 1.8em;">' + maxWeakSubject + '</div>';
    html += '<div class="stat-label">ê°€ì¥ ì·¨ì•½í•œ ê³¼ëª© (' + maxWeakCount + 'ëª…)</div>';
    html += '</div>';
    
    statsDashboard.innerHTML = html;
    console.log('âœ… í†µê³„ ëŒ€ì‹œë³´ë“œ í‘œì‹œ ì™„ë£Œ');
}

// ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ëª©ë¡ í‘œì‹œ
function displaySubjectAnalysis() {
    var subjectAnalysis = document.getElementById('subjectAnalysis');
    
    if (!subjectAnalysis) {
        console.error('âŒ subjectAnalysis ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    var html = '';
    
    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
    html += '<div style="text-align: center; margin-bottom: 30px;">';
    html += '<button class="upload-btn" onclick="downloadExcel()" style="background: linear-gradient(45deg, #10b981, #059669);">';
    html += 'ğŸ“¥ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ';
    html += '</button>';
    html += '</div>';
    
    // â­ ê³¼ëª© ìˆœì„œ ë° ì•„ì´ì½˜ (ê³µë°± ì œê±°í•œ ë²„ì „ë„ ì²´í¬) â­
    var subjectInfo = [
        { name: 'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )', icon: 'ğŸ“–', color: '#667eea' },
        { name: 'ë…ì„œ(ì‚¬íšŒ)', icon: 'ğŸ›ï¸', color: '#3b82f6' },
        { name: 'ë…ì„œ(ê³¼í•™)', icon: 'ğŸ”¬', color: '#8b5cf6' },
        { name: 'ë¬¸í•™(í˜„ëŒ€ì‹œ)', icon: 'âœï¸', color: '#ec4899' },
        { name: 'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)', icon: 'ğŸ“•', color: '#f59e0b' },
        { name: 'ë¬¸í•™(ê³ ì „ì‹œê°€)', icon: 'ğŸ­', color: '#10b981' },
        { name: 'ë¬¸í•™(ê³ ì „ì†Œì„¤)', icon: 'ğŸ“œ', color: '#06b6d4' },
        { name: 'ì–¸ì–´ í™”ë²•', icon: 'ğŸ’¬', color: '#84cc16' },
        { name: 'ë§¤ì²´ ì‘ë¬¸', icon: 'âœï¸', color: '#f43f5e' }
    ];
    
    var hasContent = false;
    
    subjectInfo.forEach(function(info) {
        var subject = info.name;
        
        // â­ weaknessAnalysisì—ì„œ ì§ì ‘ ì°¾ê¸° (ê³µë°± ë¬´ì‹œ) â­
        var students = null;
        
        // 1. ì •í™•í•œ ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
        if (weaknessAnalysis[subject]) {
            students = weaknessAnalysis[subject];
            console.log('âœ… ì •í™• ë§¤ì¹­:', subject, students.length + 'ëª…');
        } 
        // 2. ê³µë°± ì œê±°í•œ ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
        else {
            var subjectNoSpace = subject.replace(/\s/g, '');
            for (var key in weaknessAnalysis) {
                var keyNoSpace = key.replace(/\s/g, '');
                if (keyNoSpace === subjectNoSpace) {
                    students = weaknessAnalysis[key];
                    console.log('âœ… ê³µë°±ì œê±° ë§¤ì¹­:', subject, 'â†', key, students.length + 'ëª…');
                    break;
                }
            }
        }
        
        if (!students || students.length === 0) return;
        
        hasContent = true;
        
        html += '<div class="subject-card">';
        html += '<h2 style="color: ' + info.color + ';">';
        html += info.icon + ' ' + subject + ' ì·¨ì•½ í•™ìƒ';
        html += '<span style="font-size: 0.8em; margin-left: 10px; color: #ef4444;">(' + students.length + 'ëª…)</span>';
        html += '</h2>';
        
        html += '<div class="student-list">';
        
       students.forEach(function(student) {
            // â­ ìš°ì„ ìˆœìœ„ë³„ ìƒ‰ìƒ â­
            var priorityColor = student.priority === 'high' ? '#ef4444' : 
                               student.priority === 'medium' ? '#f59e0b' : '#84cc16';
            var priorityIcon = student.priority === 'high' ? 'ğŸ”´' : 
                               student.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
            
            html += '<div class="student-item" style="border-left: 4px solid ' + priorityColor + ';">';
            html += '<div class="student-name">';
            html += priorityIcon + ' ' + student.name + ' (' + student.attendanceNumber + ')';
            html += '</div>';
            html += '<div class="student-score">';
            html += 'ê³¼ëª© ì„±ì·¨ë„: <strong>' + student.subjectAverage + '%</strong>';
            html += '</div>';
            html += '<div class="student-score">';
            html += 'ë³¸ì¸ í‰ê· : <strong>' + student.studentAverage + '%</strong>';
            html += '</div>';
            html += '<div class="student-score">';
            html += '<span class="weak-indicator" style="background: ' + priorityColor + ';">-' + student.difference + '%</span>';
            html += ' ë³¸ì¸ í‰ê·  ëŒ€ë¹„';
            html += '</div>';
            html += '<div class="student-score" style="font-size: 0.85em; color: #666; margin-top: 4px;">';
            html += 'ğŸ“Š ' + student.reason;
            html += '</div>';
            html += '</div>';
        });  // â¬…ï¸ forEach ë!
        
        html += '</div>';
        html += '</div>';
    });
    
    // ì•½ì ì´ ì—†ëŠ” ê²½ìš°
    if (!hasContent) {
        html += '<div class="subject-card" style="text-align: center; padding: 60px;">';
        html += '<h2 style="color: #10b981;">ğŸ‰ ëª¨ë“  í•™ìƒì´ ê³ ë¥´ê²Œ ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤!</h2>';
        html += '<p style="color: #666; margin-top: 15px;">ë³¸ì¸ í‰ê·  ì„±ì·¨ë„ ëŒ€ë¹„ 10% ì´ìƒ ë‚®ì€ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        html += '</div>';
    }
    
    subjectAnalysis.innerHTML = html;
    console.log('âœ… ê³¼ëª©ë³„ ë¶„ì„ í‘œì‹œ ì™„ë£Œ');
}

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadExcel() {
    console.log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
    
    var wb = XLSX.utils.book_new();
    
    // ê° ê³¼ëª©ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
    for (var subject in weaknessAnalysis) {
        var students = weaknessAnalysis[subject];
        
        if (students.length === 0) continue;
        
        // ë°ì´í„° ë°°ì—´ ìƒì„±
        var data = [
            ['ì´ë¦„', 'ì¶œê²°ë²ˆí˜¸', 'ê³¼ëª© í‰ê· ', 'ë³¸ì¸ í‰ê· ', 'ì°¨ì´']
        ];
        
        students.forEach(function(student) {
            data.push([
                student.name,
                student.attendanceNumber,
                student.subjectAverage,
                student.studentAverage,
                student.difference
            ]);
        });
        
        // ì‹œíŠ¸ ìƒì„±
        var ws = XLSX.utils.aoa_to_sheet(data);
        
        // ì‹œíŠ¸ëª… (íŠ¹ìˆ˜ë¬¸ì ì œê±°)
        var sheetName = subject.replace(/[()]/g, '').substring(0, 31);
        
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    }
    
    // ì „ì²´ ìš”ì•½ ì‹œíŠ¸
    var summaryData = [
        ['ê³¼ëª©', 'ì·¨ì•½ í•™ìƒ ìˆ˜']
    ];
    
    for (var subject in weaknessAnalysis) {
        summaryData.push([
            subject,
            weaknessAnalysis[subject].length
        ]);
    }
    
    var summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, summaryWs, 'ì „ì²´ìš”ì•½');
    
    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    var today = new Date();
    var filename = 'í•™ìƒì•½ì ë¶„ì„_' + 
                   today.getFullYear() + 
                   ('0' + (today.getMonth() + 1)).slice(-2) + 
                   ('0' + today.getDate()).slice(-2) + 
                   '.xlsx';
    
    XLSX.writeFile(wb, filename);
    
    console.log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
}

        // ===== í•™ìƒë³„ ìµœëŒ€ì•½ì  ì—‘ì…€ ë‹¤ìš´ë¡œë“œ =====
function downloadStudentExcel() {
    console.log('í•™ìƒë³„ ì•½ì  ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
    
    var studentMaxWeakness = analyzeStudentMaxWeakness();
    
    // â­ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (ì¬ê³„ì‚° ë¶ˆí•„ìš”) â­
    if (!studentMaxWeakness || studentMaxWeakness.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € "í•™ìƒë³„ ìµœëŒ€ì•½ì " íƒ­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    var wb = XLSX.utils.book_new();
    
    // 1. í•™ìƒë³„ ìµœëŒ€ì•½ì  ì‹œíŠ¸
    var studentData = [
        ['ìš°ì„ ìˆœìœ„', 'ì´ë¦„', 'ì¶œê²°ë²ˆí˜¸', 'ìµœëŒ€ì•½ì  ê³¼ëª©', 'ê³¼ëª© ì„±ì·¨ë„(%)', 'ë³¸ì¸ í‰ê· (%)', 'ì°¨ì´(%)', 'Z-Score', 'ì•½ì  ì‚¬ìœ ']
    ];
    
    studentMaxWeakness.forEach(function(student) {
        var priorityText = student.priority === 'high' ? 'ğŸ”´ ê¸´ê¸‰' : 
                          student.priority === 'medium' ? 'ğŸŸ¡ ì£¼ì˜' : 'ğŸŸ¢ ì¼ë°˜';
        
        studentData.push([
            priorityText,
            student.name,
            student.attendanceNumber,
            student.subject,
            student.subjectAverage,
            student.studentAverage,
            student.difference,
            student.avgZScore,
            student.reason
        ]);
    });
    
    var ws = XLSX.utils.aoa_to_sheet(studentData);
    
    // ì—´ ë„ˆë¹„ ì„¤ì •
    ws['!cols'] = [
        {wch: 10},  // ìš°ì„ ìˆœìœ„
        {wch: 10},  // ì´ë¦„
        {wch: 10},  // ì¶œê²°ë²ˆí˜¸
        {wch: 20},  // ìµœëŒ€ì•½ì  ê³¼ëª©
        {wch: 15},  // ê³¼ëª© ì„±ì·¨ë„
        {wch: 15},  // ë³¸ì¸ í‰ê· 
        {wch: 10},  // ì°¨ì´
        {wch: 10},  // Z-Score
        {wch: 30}   // ì•½ì  ì‚¬ìœ 
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒë³„ìµœëŒ€ì•½ì ');
    
    // 2. ìš°ì„ ìˆœìœ„ë³„ í†µê³„ ì‹œíŠ¸
    var highCount = studentMaxWeakness.filter(s => s.priority === 'high').length;
    var mediumCount = studentMaxWeakness.filter(s => s.priority === 'medium').length;
    var lowCount = studentMaxWeakness.filter(s => s.priority === 'low').length;
    
    var statsData = [
        ['ìš°ì„ ìˆœìœ„', 'í•™ìƒ ìˆ˜', 'ë¹„ìœ¨(%)'],
        ['ğŸ”´ ê¸´ê¸‰ (High)', highCount, Math.round((highCount / studentMaxWeakness.length) * 100)],
        ['ğŸŸ¡ ì£¼ì˜ (Medium)', mediumCount, Math.round((mediumCount / studentMaxWeakness.length) * 100)],
        ['ğŸŸ¢ ì¼ë°˜ (Low)', lowCount, Math.round((lowCount / studentMaxWeakness.length) * 100)],
        ['ì „ì²´', studentMaxWeakness.length, 100]
    ];
    
    var statsWs = XLSX.utils.aoa_to_sheet(statsData);
    XLSX.utils.book_append_sheet(wb, statsWs, 'ìš°ì„ ìˆœìœ„ë³„í†µê³„');
    
    // 3. ê³¼ëª©ë³„ í•™ìƒ ìˆ˜ í†µê³„ ì‹œíŠ¸
    var subjectCount = {};
    
    studentMaxWeakness.forEach(function(student) {
        if (!subjectCount[student.subject]) {
            subjectCount[student.subject] = 0;
        }
        subjectCount[student.subject]++;
    });
    
    var subjectStatsData = [
        ['ê³¼ëª©', 'ìµœëŒ€ì•½ì  í•™ìƒ ìˆ˜']
    ];
    
    // ê³¼ëª©ë³„ ì •ë ¬ (í•™ìƒ ìˆ˜ ë§ì€ ìˆœ)
    var sortedSubjects = Object.keys(subjectCount).sort(function(a, b) {
        return subjectCount[b] - subjectCount[a];
    });
    
    sortedSubjects.forEach(function(subject) {
        subjectStatsData.push([subject, subjectCount[subject]]);
    });
    
    var subjectStatsWs = XLSX.utils.aoa_to_sheet(subjectStatsData);
    XLSX.utils.book_append_sheet(wb, subjectStatsWs, 'ê³¼ëª©ë³„í†µê³„');
    
    // 4. ê¸´ê¸‰ í•™ìƒ ë¦¬ìŠ¤íŠ¸ (High priorityë§Œ)
    var urgentStudents = studentMaxWeakness.filter(s => s.priority === 'high');
    
    if (urgentStudents.length > 0) {
        var urgentData = [
            ['ì´ë¦„', 'ì¶œê²°ë²ˆí˜¸', 'ìµœëŒ€ì•½ì  ê³¼ëª©', 'ê³¼ëª© ì„±ì·¨ë„(%)', 'ë³¸ì¸ í‰ê· (%)', 'ì°¨ì´(%)', 'ì•½ì  ì‚¬ìœ ']
        ];
        
        urgentStudents.forEach(function(student) {
            urgentData.push([
                student.name,
                student.attendanceNumber,
                student.subject,
                student.subjectAverage,
                student.studentAverage,
                student.difference,
                student.reason
            ]);
        });
        
        var urgentWs = XLSX.utils.aoa_to_sheet(urgentData);
        XLSX.utils.book_append_sheet(wb, urgentWs, 'ğŸ”´ê¸´ê¸‰í•™ìƒ');
    }
    
    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    var today = new Date();
    var filename = 'í•™ìƒë³„ìµœëŒ€ì•½ì ë¶„ì„_' + 
                   today.getFullYear() + 
                   ('0' + (today.getMonth() + 1)).slice(-2) + 
                   ('0' + today.getDate()).slice(-2) + 
                   '.xlsx';
    
    XLSX.writeFile(wb, filename);
    
    console.log('í•™ìƒë³„ ì•½ì  ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
}


         </script>
</body>
</html>
