<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ìš© ì„±ì  ë¶„ì„ ì‹œìŠ¤í…œ (ê³ 3)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        /* ì—…ë¡œë“œ ì„¹ì…˜ */
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8f2ff;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ */
        .analysis-section {
            display: none;
        }
        
        .subject-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .subject-card h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .student-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #ef4444;
            transition: all 0.3s;
        }
        
        .student-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .student-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }
        
        .student-score {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 4px;
        }
        
        .weak-indicator {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        /* í†µê³„ ëŒ€ì‹œë³´ë“œ */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .student-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¨â€ğŸ« êµì‚¬ìš© ì„±ì  ë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p>ê³ 3 í•™ìƒë“¤ì˜ ê³¼ëª©ë³„ ì•½ì  ë¶„ì„ â€¢ ì •ë™ë¯¼êµ­ì–´ë…¼ìˆ í•™ì›</p>
        </div>
        
        <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="upload-section">
            <h3 style="margin-bottom: 20px; color: #333;">ğŸ“‚ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
            <div class="upload-area" id="uploadArea">
                <h3>ğŸ“ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h3>
                <p style="color: #666; margin-top: 10px;">í•™ìƒ ì„±ì  ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">íŒŒì¼ ì„ íƒ</button>
            </div>
        </div>
        
        <!-- ë¡œë”© -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        
        <!-- ë¶„ì„ ê²°ê³¼ -->
        <div class="analysis-section" id="analysisSection">
            <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
            <div class="stats-dashboard" id="statsDashboard"></div>
            
            <!-- ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ëª©ë¡ -->
            <div id="subjectAnalysis"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        var studentData = {};
        var weaknessAnalysis = {};
        
        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        var uploadArea = document.getElementById('uploadArea');
        var fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });


        // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
function processFile(file) {
    console.log('íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:', file.name);
    
    // ë¡œë”© í‘œì‹œ
    document.getElementById('loading').style.display = 'block';
    document.getElementById('analysisSection').style.display = 'none';
    
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            
            console.log('ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì™„ë£Œ');
            console.log('ì‹œíŠ¸ ëª©ë¡:', workbook.SheetNames);
            
            // ë°ì´í„° íŒŒì‹±
            parseStudentData(workbook);
            
            // ì•½ì  ë¶„ì„
            analyzeWeaknesses();
            
            // ê²°ê³¼ í‘œì‹œ
            displayResults();
            
            // ë¡œë”© ìˆ¨ê¸°ê¸°
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'block';
            
        } catch (error) {
            alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            console.error('ì˜¤ë¥˜:', error);
            document.getElementById('loading').style.display = 'none';
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// í•™ìƒ ë°ì´í„° íŒŒì‹±
function parseStudentData(workbook) {
    studentData = {};
    
    console.log('=== í•™ìƒ ë°ì´í„° íŒŒì‹± ì‹œì‘ ===');
    
    // 1. ì¶œê²°ë²ˆí˜¸-ì´ë¦„ ë§¤í•‘ (2ë²ˆì§¸ ì‹œíŠ¸)
    var attendanceToNameMap = {};
    var mappingSheetName = workbook.SheetNames[1];
    
    if (workbook.Sheets[mappingSheetName]) {
        var mappingSheet = workbook.Sheets[mappingSheetName];
        var mappingData = XLSX.utils.sheet_to_json(mappingSheet, {header: 1});
        
        for (var i = 1; i < mappingData.length; i++) {
            var row = mappingData[i];
            if (row && row[0] && row[1]) {
                var name = row[0];
                var attendanceNumber = row[1];
                attendanceToNameMap[attendanceNumber] = name;
                
                // í•™ìƒ ë°ì´í„° ì´ˆê¸°í™”
                studentData[attendanceNumber] = {
                    name: name,
                    attendanceNumber: attendanceNumber,
                    testScores: {},  // ì‹œí—˜ë³„ ê³¼ëª© ì ìˆ˜
                    subjectAverages: {}  // ê³¼ëª©ë³„ í‰ê· 
                };
            }
        }
    }
    
    console.log('ë§¤í•‘ëœ í•™ìƒ ìˆ˜:', Object.keys(attendanceToNameMap).length);
    
    // 2. ëª¨í´ ì‹œíŠ¸ë“¤ì—ì„œ ì„±ì  ë°ì´í„° ì¶”ì¶œ
    var allSheetNames = workbook.SheetNames;
    var testSheetNames = [];
    
    for (var i = 0; i < allSheetNames.length; i++) {
        var sheetName = allSheetNames[i];
        if ((sheetName.includes('ëª¨í´') || sheetName.includes('ì´ê°') || sheetName.includes('ì§„ë‹¨í‰ê°€')) && 
            !sheetName.includes('ì„±ì í‘œ') && sheetName !== 'ë“±ê¸‰ì»·' && sheetName !== 'ì¶œê²°ë²ˆí˜¸') {
            testSheetNames.push(sheetName);
        }
    }
    
    console.log('ë°œê²¬ëœ ì‹œí—˜ ì‹œíŠ¸:', testSheetNames);
    
    // 3. ìµœê·¼ 10íšŒ ì‹œí—˜ë§Œ ì„ íƒ
    var recentTests = testSheetNames.slice(-10);
    console.log('ìµœê·¼ 10íšŒ ì‹œí—˜:', recentTests);
    
    // 4. ê° ì‹œí—˜ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
    for (var s = 0; s < recentTests.length; s++) {
        var sheetName = recentTests[s];
        if (!workbook.Sheets[sheetName]) continue;
        
        var worksheet = workbook.Sheets[sheetName];
        var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
        
        if (jsonData.length <= 1) continue;
        
        var headers = jsonData[0];
        console.log('\nì²˜ë¦¬ ì¤‘:', sheetName);
        
        // ê° í•™ìƒ ë°ì´í„° ì²˜ë¦¬
        for (var i = 1; i < jsonData.length; i++) {
            var row = jsonData[i];
            if (!row || !row[0]) continue;
            
            var name = row[0];
            var attendanceNumber = row[1];
            
            if (!studentData[attendanceNumber]) continue;
            
            // ì‹œí—˜ë³„ ê³¼ëª© ì ìˆ˜ ì €ì¥ (5ì—´ë¶€í„°)
            var testScores = {};
            
            for (var j = 5; j < Math.min(headers.length, row.length); j++) {
                var subject = normalizeHeader(headers[j]);
                var score = row[j];
                
                if (subject && score !== null && score !== undefined && score !== '') {
                    testScores[subject] = parseFloat(score);
                }
            }
            
            studentData[attendanceNumber].testScores[sheetName] = testScores;
        }
    }
    
    // 5. ê° í•™ìƒì˜ ê³¼ëª©ë³„ í‰ê·  ê³„ì‚°
    for (var attendanceNumber in studentData) {
        var student = studentData[attendanceNumber];
        var subjectTotals = {};
        var subjectCounts = {};
        
        // ëª¨ë“  ì‹œí—˜ì˜ ê³¼ëª© ì ìˆ˜ í•©ì‚°
        for (var testName in student.testScores) {
            var testScores = student.testScores[testName];
            
            for (var subject in testScores) {
                if (!subjectTotals[subject]) {
                    subjectTotals[subject] = 0;
                    subjectCounts[subject] = 0;
                }
                
                subjectTotals[subject] += testScores[subject];
                subjectCounts[subject]++;
            }
        }
        
        // í‰ê·  ê³„ì‚°
        for (var subject in subjectTotals) {
            student.subjectAverages[subject] = subjectTotals[subject] / subjectCounts[subject];
        }
    }
    
    console.log('íŒŒì‹± ì™„ë£Œ. í•™ìƒ ìˆ˜:', Object.keys(studentData).length);
}

// í—¤ë” ì •ê·œí™” í•¨ìˆ˜
function normalizeHeader(header) {
    if (!header) return '';
    return String(header).replace(/\s/g, '').trim();
}

        // ì•½ì  ë¶„ì„ í•¨ìˆ˜
function analyzeWeaknesses() {
    weaknessAnalysis = {};
    
    console.log('=== ì•½ì  ë¶„ì„ ì‹œì‘ ===');
    
    // ê³¼ëª© ëª©ë¡ ì •ì˜
    var subjects = [
        'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )',
        'ë…ì„œ(ì‚¬íšŒ)',
        'ë…ì„œ(ê³¼í•™)',
        'ë¬¸í•™(í˜„ëŒ€ì‹œ)',
        'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)',
        'ë¬¸í•™(ê³ ì „ì‹œê°€)',
        'ë¬¸í•™(ê³ ì „ì†Œì„¤)',
        'ì–¸ì–´í™”ë²•',
        'ë§¤ì²´ì‘ë¬¸'
    ];
    
    // ê° ê³¼ëª©ë³„ë¡œ ì´ˆê¸°í™”
    subjects.forEach(function(subject) {
        weaknessAnalysis[subject] = [];
    });
    
    // ê° í•™ìƒ ë¶„ì„
    for (var attendanceNumber in studentData) {
        var student = studentData[attendanceNumber];
        
        // ê³¼ëª©ë³„ í‰ê· ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if (Object.keys(student.subjectAverages).length === 0) continue;
        
        // í•™ìƒì˜ ì „ì²´ í‰ê·  ê³„ì‚°
        var totalSum = 0;
        var totalCount = 0;
        
        for (var subject in student.subjectAverages) {
            totalSum += student.subjectAverages[subject];
            totalCount++;
        }
        
        var studentAverage = totalSum / totalCount;
        
        // ê° ê³¼ëª©ì´ í‰ê· ë³´ë‹¤ ë‚®ì€ì§€ í™•ì¸
        for (var subject in student.subjectAverages) {
            var subjectAverage = student.subjectAverages[subject];
            var difference = studentAverage - subjectAverage;
            
            // ë³¸ì¸ í‰ê· ë³´ë‹¤ 5ì  ì´ìƒ ë‚®ìœ¼ë©´ ì•½ì ìœ¼ë¡œ íŒì •
            if (difference >= 5) {
                // ê³¼ëª©ëª… ë§¤ì¹­
                var matchedSubject = findMatchingSubject(subject, subjects);
                
                if (matchedSubject && weaknessAnalysis[matchedSubject]) {
                    weaknessAnalysis[matchedSubject].push({
                        name: student.name,
                        attendanceNumber: attendanceNumber,
                        subjectAverage: Math.round(subjectAverage * 10) / 10,
                        studentAverage: Math.round(studentAverage * 10) / 10,
                        difference: Math.round(difference * 10) / 10
                    });
                }
            }
        }
    }
    
    // ê° ê³¼ëª©ë³„ë¡œ ì°¨ì´ê°€ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬
    for (var subject in weaknessAnalysis) {
        weaknessAnalysis[subject].sort(function(a, b) {
            return b.difference - a.difference;
        });
    }
    
    console.log('ì•½ì  ë¶„ì„ ì™„ë£Œ:', weaknessAnalysis);
}

// ê³¼ëª©ëª… ë§¤ì¹­ í•¨ìˆ˜
function findMatchingSubject(actualSubject, standardSubjects) {
    var subjectMapping = {
        'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )': ['ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )', 'ë…ì„œ(ì¸ë¬¸ì´ë¡ )', 'ë…ì„œì¸ë¬¸', 'ì¸ë¬¸'],
        'ë…ì„œ(ì‚¬íšŒ)': ['ë…ì„œ(ì‚¬íšŒ)', 'ë…ì„œì‚¬íšŒ', 'ì‚¬íšŒ'],
        'ë…ì„œ(ê³¼í•™)': ['ë…ì„œ(ê³¼í•™)', 'ë…ì„œê³¼í•™', 'ê³¼í•™'],
        'ë¬¸í•™(í˜„ëŒ€ì‹œ)': ['ë¬¸í•™(í˜„ëŒ€ì‹œ)', 'ë¬¸í•™í˜„ëŒ€ì‹œ', 'í˜„ëŒ€ì‹œ', 'í˜„ì‹œ'],
        'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)': ['ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)', 'ë¬¸í•™í˜„ëŒ€ì†Œì„¤', 'í˜„ëŒ€ì†Œì„¤', 'í˜„ì†Œ'],
        'ë¬¸í•™(ê³ ì „ì‹œê°€)': ['ë¬¸í•™(ê³ ì „ì‹œê°€)', 'ë¬¸í•™ê³ ì „ì‹œê°€', 'ê³ ì „ì‹œê°€', 'ê³ ì‹œ'],
        'ë¬¸í•™(ê³ ì „ì†Œì„¤)': ['ë¬¸í•™(ê³ ì „ì†Œì„¤)', 'ë¬¸í•™ê³ ì „ì†Œì„¤', 'ê³ ì „ì†Œì„¤', 'ê³ ì†Œ'],
        'ì–¸ì–´í™”ë²•': ['ì–¸ì–´í™”ë²•', 'ì–¸ì–´ í™”ë²•', 'í™”ë²•'],
        'ë§¤ì²´ì‘ë¬¸': ['ë§¤ì²´ì‘ë¬¸', 'ë§¤ì²´ ì‘ë¬¸', 'ì‘ë¬¸']
    };
    
    for (var standardSubject in subjectMapping) {
        var aliases = subjectMapping[standardSubject];
        
        for (var i = 0; i < aliases.length; i++) {
            if (actualSubject === aliases[i] || 
                actualSubject.includes(aliases[i]) || 
                aliases[i].includes(actualSubject)) {
                return standardSubject;
            }
        }
    }
    
    return null;
}

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function displayResults() {
    console.log('=== ê²°ê³¼ í‘œì‹œ ì‹œì‘ ===');
    
    // 1. í†µê³„ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
    displayStatsDashboard();
    
    // 2. ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ëª©ë¡ í‘œì‹œ
    displaySubjectAnalysis();
}

// í†µê³„ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
function displayStatsDashboard() {
    var statsDashboard = document.getElementById('statsDashboard');
    
    // ì „ì²´ í•™ìƒ ìˆ˜
    var totalStudents = Object.keys(studentData).length;
    
    // ë¶„ì„ëœ ê³¼ëª© ìˆ˜
    var analyzedSubjects = Object.keys(weaknessAnalysis).filter(function(subject) {
        return weaknessAnalysis[subject].length > 0;
    }).length;
    
    // ì•½ì ì´ ìˆëŠ” í•™ìƒ ìˆ˜ (ì¤‘ë³µ ì œê±°)
    var weakStudentsSet = new Set();
    for (var subject in weaknessAnalysis) {
        weaknessAnalysis[subject].forEach(function(student) {
            weakStudentsSet.add(student.attendanceNumber);
        });
    }
    var weakStudentsCount = weakStudentsSet.size;
    
    // ê°€ì¥ ë§ì€ í•™ìƒì´ ì•½í•œ ê³¼ëª©
    var maxWeakSubject = '';
    var maxWeakCount = 0;
    for (var subject in weaknessAnalysis) {
        if (weaknessAnalysis[subject].length > maxWeakCount) {
            maxWeakCount = weaknessAnalysis[subject].length;
            maxWeakSubject = subject;
        }
    }
    
    var html = '';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value">' + totalStudents + '</div>';
    html += '<div class="stat-label">ì „ì²´ í•™ìƒ ìˆ˜</div>';
    html += '</div>';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value">' + analyzedSubjects + '</div>';
    html += '<div class="stat-label">ë¶„ì„ëœ ê³¼ëª© ìˆ˜</div>';
    html += '</div>';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value">' + weakStudentsCount + '</div>';
    html += '<div class="stat-label">ì•½ì ì´ ìˆëŠ” í•™ìƒ</div>';
    html += '</div>';
    
    html += '<div class="stat-card">';
    html += '<div class="stat-value" style="font-size: 1.8em;">' + maxWeakSubject + '</div>';
    html += '<div class="stat-label">ê°€ì¥ ì·¨ì•½í•œ ê³¼ëª© (' + maxWeakCount + 'ëª…)</div>';
    html += '</div>';
    
    statsDashboard.innerHTML = html;
}

// ê³¼ëª©ë³„ ì•½ì  í•™ìƒ ëª©ë¡ í‘œì‹œ
function displaySubjectAnalysis() {
    var subjectAnalysis = document.getElementById('subjectAnalysis');
    
    var html = '';
    
    // ê³¼ëª© ìˆœì„œ ë° ì•„ì´ì½˜
    var subjectInfo = [
        { name: 'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )', icon: 'ğŸ“–', color: '#667eea' },
        { name: 'ë…ì„œ(ì‚¬íšŒ)', icon: 'ğŸ›ï¸', color: '#3b82f6' },
        { name: 'ë…ì„œ(ê³¼í•™)', icon: 'ğŸ”¬', color: '#8b5cf6' },
        { name: 'ë¬¸í•™(í˜„ëŒ€ì‹œ)', icon: 'âœï¸', color: '#ec4899' },
        { name: 'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)', icon: 'ğŸ“•', color: '#f59e0b' },
        { name: 'ë¬¸í•™(ê³ ì „ì‹œê°€)', icon: 'ğŸ­', color: '#10b981' },
        { name: 'ë¬¸í•™(ê³ ì „ì†Œì„¤)', icon: 'ğŸ“œ', color: '#06b6d4' },
        { name: 'ì–¸ì–´í™”ë²•', icon: 'ğŸ’¬', color: '#84cc16' },
        { name: 'ë§¤ì²´ì‘ë¬¸', icon: 'âœï¸', color: '#f43f5e' }
    ];
    
    subjectInfo.forEach(function(info) {
        var subject = info.name;
        var students = weaknessAnalysis[subject] || [];
        
        if (students.length === 0) return;  // ì•½ì  í•™ìƒì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        
        html += '<div class="subject-card">';
        html += '<h2 style="color: ' + info.color + ';">';
        html += info.icon + ' ' + subject + ' ì·¨ì•½ í•™ìƒ';
        html += '<span style="font-size: 0.8em; margin-left: 10px; color: #ef4444;">(' + students.length + 'ëª…)</span>';
        html += '</h2>';
        
        html += '<div class="student-list">';
        
        students.forEach(function(student) {
            html += '<div class="student-item">';
            html += '<div class="student-name">';
            html += student.name + ' (' + student.attendanceNumber + ')';
            html += '</div>';
            html += '<div class="student-score">';
            html += 'ê³¼ëª© í‰ê· : <strong>' + student.subjectAverage + 'ì </strong>';
            html += '</div>';
            html += '<div class="student-score">';
            html += 'ë³¸ì¸ í‰ê· : <strong>' + student.studentAverage + 'ì </strong>';
            html += '</div>';
            html += '<div class="student-score">';
            html += '<span class="weak-indicator">-' + student.difference + 'ì </span>';
            html += ' ë³¸ì¸ í‰ê·  ëŒ€ë¹„';
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';  // student-list ë‹«ê¸°
        html += '</div>';  // subject-card ë‹«ê¸°
    });
    
    // ì•½ì ì´ ì—†ëŠ” ê²½ìš°
    if (html === '') {
        html = '<div class="subject-card" style="text-align: center; padding: 60px;">';
        html += '<h2 style="color: #10b981;">ğŸ‰ ëª¨ë“  í•™ìƒì´ ê³ ë¥´ê²Œ ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤!</h2>';
        html += '<p style="color: #666; margin-top: 15px;">ë³¸ì¸ í‰ê·  ëŒ€ë¹„ 5ì  ì´ìƒ ë‚®ì€ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        html += '</div>';
    }
    
    subjectAnalysis.innerHTML = html;
}

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadExcel() {
    console.log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
    
    var wb = XLSX.utils.book_new();
    
    // ê° ê³¼ëª©ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
    for (var subject in weaknessAnalysis) {
        var students = weaknessAnalysis[subject];
        
        if (students.length === 0) continue;
        
        // ë°ì´í„° ë°°ì—´ ìƒì„±
        var data = [
            ['ì´ë¦„', 'ì¶œê²°ë²ˆí˜¸', 'ê³¼ëª© í‰ê· ', 'ë³¸ì¸ í‰ê· ', 'ì°¨ì´']
        ];
        
        students.forEach(function(student) {
            data.push([
                student.name,
                student.attendanceNumber,
                student.subjectAverage,
                student.studentAverage,
                student.difference
            ]);
        });
        
        // ì‹œíŠ¸ ìƒì„±
        var ws = XLSX.utils.aoa_to_sheet(data);
        
        // ì‹œíŠ¸ëª… (íŠ¹ìˆ˜ë¬¸ì ì œê±°)
        var sheetName = subject.replace(/[()]/g, '').substring(0, 31);
        
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    }
    
    // ì „ì²´ ìš”ì•½ ì‹œíŠ¸
    var summaryData = [
        ['ê³¼ëª©', 'ì·¨ì•½ í•™ìƒ ìˆ˜']
    ];
    
    for (var subject in weaknessAnalysis) {
        summaryData.push([
            subject,
            weaknessAnalysis[subject].length
        ]);
    }
    
    var summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, summaryWs, 'ì „ì²´ìš”ì•½');
    
    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    var today = new Date();
    var filename = 'í•™ìƒì•½ì ë¶„ì„_' + 
                   today.getFullYear() + 
                   ('0' + (today.getMonth() + 1)).slice(-2) + 
                   ('0' + today.getDate()).slice(-2) + 
                   '.xlsx';
    
    XLSX.writeFile(wb, filename);
    
    console.log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
}

        function displaySubjectAnalysis() {
    var subjectAnalysis = document.getElementById('subjectAnalysis');
    
    var html = '';
    
    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
    html += '<div style="text-align: center; margin-bottom: 30px;">';
    html += '<button class="upload-btn" onclick="downloadExcel()" style="background: linear-gradient(45deg, #10b981, #059669);">';
    html += 'ğŸ“¥ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ';
    html += '</button>';
    html += '</div>';
    
    // ê³¼ëª© ìˆœì„œ ë° ì•„ì´ì½˜
    var subjectInfo = [
        { name: 'ë…ì„œ(ì¸ë¬¸,ë…ì„œë¡ )', icon: 'ğŸ“–', color: '#667eea' },
        { name: 'ë…ì„œ(ì‚¬íšŒ)', icon: 'ğŸ›ï¸', color: '#3b82f6' },
        { name: 'ë…ì„œ(ê³¼í•™)', icon: 'ğŸ”¬', color: '#8b5cf6' },
        { name: 'ë¬¸í•™(í˜„ëŒ€ì‹œ)', icon: 'âœï¸', color: '#ec4899' },
        { name: 'ë¬¸í•™(í˜„ëŒ€ì†Œì„¤)', icon: 'ğŸ“•', color: '#f59e0b' },
        { name: 'ë¬¸í•™(ê³ ì „ì‹œê°€)', icon: 'ğŸ­', color: '#10b981' },
        { name: 'ë¬¸í•™(ê³ ì „ì†Œì„¤)', icon: 'ğŸ“œ', color: '#06b6d4' },
        { name: 'ì–¸ì–´í™”ë²•', icon: 'ğŸ’¬', color: '#84cc16' },
        { name: 'ë§¤ì²´ì‘ë¬¸', icon: 'âœï¸', color: '#f43f5e' }
    ];
    
    subjectInfo.forEach(function(info) {
        var subject = info.name;
        var students = weaknessAnalysis[subject] || [];
        
        if (students.length === 0) return;
        
        html += '<div class="subject-card">';
        html += '<h2 style="color: ' + info.color + ';">';
        html += info.icon + ' ' + subject + ' ì·¨ì•½ í•™ìƒ';
        html += '<span style="font-size: 0.8em; margin-left: 10px; color: #ef4444;">(' + students.length + 'ëª…)</span>';
        html += '</h2>';
        
        html += '<div class="student-list">';
        
        students.forEach(function(student) {
            html += '<div class="student-item">';
            html += '<div class="student-name">';
            html += student.name + ' (' + student.attendanceNumber + ')';
            html += '</div>';
            html += '<div class="student-score">';
            html += 'ê³¼ëª© í‰ê· : <strong>' + student.subjectAverage + 'ì </strong>';
            html += '</div>';
            html += '<div class="student-score">';
            html += 'ë³¸ì¸ í‰ê· : <strong>' + student.studentAverage + 'ì </strong>';
            html += '</div>';
            html += '<div class="student-score">';
            html += '<span class="weak-indicator">-' + student.difference + 'ì </span>';
            html += ' ë³¸ì¸ í‰ê·  ëŒ€ë¹„';
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';
        html += '</div>';
    });
    
    if (html === '<div style="text-align: center; margin-bottom: 30px;"><button class="upload-btn" onclick="downloadExcel()" style="background: linear-gradient(45deg, #10b981, #059669);">ğŸ“¥ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button></div>') {
        html += '<div class="subject-card" style="text-align: center; padding: 60px;">';
        html += '<h2 style="color: #10b981;">ğŸ‰ ëª¨ë“  í•™ìƒì´ ê³ ë¥´ê²Œ ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤!</h2>';
        html += '<p style="color: #666; margin-top: 15px;">ë³¸ì¸ í‰ê·  ëŒ€ë¹„ 5ì  ì´ìƒ ë‚®ì€ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        html += '</div>';
    }
    
    subjectAnalysis.innerHTML = html;
}

         </script>
</body>
</html>
